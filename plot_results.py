#!/usr/bin/env python3
"""Plot Go-back-N experiment averages from CSV outputs."""

from __future__ import annotations

import argparse
import csv
import sys
from pathlib import Path
from typing import Dict, List, Tuple
import matplotlib.pyplot as plt


def load_averages(csv_path: Path) -> List[Dict[str, float]]:
    """Read averages.csv generated by run_experiments.py."""

    rows: List[Dict[str, float]] = []
    with csv_path.open("r", encoding="utf-8", newline="") as handle:
        reader = csv.DictReader(handle)
        for row in reader:
            try:
                value = float(row["value"])
                avg_duration = float(row["avg_duration_s"])
            except (KeyError, TypeError, ValueError):
                continue
            rows.append(
                {
                    "experiment": row.get("experiment", ""),
                    "parameter": row.get("parameter", ""),
                    "value": value,
                    "avg_duration_s": avg_duration,
                }
            )
    return rows


def plot_experiment(
    averages: List[Dict[str, float]],
    experiment_name: str,
    xlabel: str,
    output_file: Path,
) -> None:
    """Render a line plot (value vs average delay) for a given experiment."""

    points = [
        (row["value"], row["avg_duration_s"])
        for row in averages
        if row["experiment"] == experiment_name and row["avg_duration_s"] is not None
    ]
    if not points:
        print(f"Skipping {experiment_name}: no rows found in CSV")
        return

    points.sort(key=lambda item: item[0])
    xs = [p[0] for p in points]
    ys = [p[1] for p in points]

    plt.figure()
    plt.plot(xs, ys, marker="o")
    plt.title(f"Average Delay vs {xlabel}")
    plt.xlabel(xlabel)
    plt.ylabel("Average delay (s)")
    plt.grid(True, alpha=0.3)
    output_file.parent.mkdir(parents=True, exist_ok=True)
    plt.savefig(output_file, bbox_inches="tight")
    plt.close()
    print(f"Wrote {output_file}")


def parse_args(argv: List[str]) -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Plot Go-back-N experiment results from averages.csv"
    )
    parser.add_argument(
        "--averages-csv",
        default="output/averages.csv",
        help="Path to the averages.csv file generated by run_experiments.py",
    )
    parser.add_argument(
        "--output-dir",
        default="output",
        help="Directory for the generated PNG plots (default: output)",
    )
    return parser.parse_args(argv)


def main(argv: List[str]) -> None:

    args = parse_args(argv)
    csv_path = Path(args.averages_csv)
    if not csv_path.exists():
        raise FileNotFoundError(csv_path)

    averages = load_averages(csv_path)
    output_dir = Path(args.output_dir)

    plot_experiment(
        averages,
        experiment_name="window_sweep",
        xlabel="Window size N",
        output_file=output_dir / "plot_window_vs_delay.png",
    )
    plot_experiment(
        averages,
        experiment_name="mss_sweep",
        xlabel="MSS (bytes)",
        output_file=output_dir / "plot_mss_vs_delay.png",
    )
    plot_experiment(
        averages,
        experiment_name="loss_sweep",
        xlabel="Loss probability p",
        output_file=output_dir / "plot_loss_vs_delay.png",
    )


if __name__ == "__main__":
    try:
        main(sys.argv[1:])
    except KeyboardInterrupt:
        print("Interrupted by user", file=sys.stderr)
